---
layout:     post
title:      "交换机可以使不同网段的终端通信吗"
date:       2020-01-29 19:11:00
author:     "KM"
catalog: true
tags:
    - Net

---
# 交换机可以使不同网段的终端通信吗

## 交换机工作原理

交换机是工作在MAC层，怎么理解这句话？交换机在接收到数据包的时候是不会比对IP头部的IP地址的，它只会判断数据包中目标MAC地址的设备是接在那个端口，然后直接把数据包发给它。

## 交换机可以使不同网段的终端通信吗

答案是：不能。

比如设备A的IP 192.168.1.2，子网掩码255.255.255.0，设备B的IP 192.168.2.2，子网掩码255.255.255.0，这两个设备都接到同一台交换机，发现无法ping通。我感到奇怪，虽然我子网掩码不同，但是交换机是工作在MAC层，通信时它又不会比对IP地址，那么为什么无法通信？

交换机有多个端口，分别接不同设备，比如端口1接设备A，端口2接设备2，当设备A要往设备B发送数据包，设备A需要创建数据包（包括MAC头部，IP头部和TCP头部）。

创建IP头部时需要知道源设备IP(即设备A IP)，源设备MAC地址(即设备A MAC地址)，目标设备IP(即设备B IP)，目标设备MAC地址(即设备B MAC地址)，我们通信前肯定是知道通信目标对象的IP的，但是通信目标对象的MAC地址是不知道的，所以这时需要用到ARP协议。

ARP协议其实就是通过目标IP获取目标MAC地址。首先设备A向整个子网广播查询MAC地址的数据包，广播包的特点是MAC地址为FF:FF:FF:FF:FF:FF，这样整个子网的设备都能收到该广播包，但是只有设备B收到广播包之后会将自己的MAC地址回复给设备A。

ARP协议规定只能给同一子网的所有设备广播，为什么呢？如果ARP可以给多个网络广播，那就会造成网络中多出很多广播包，造成网络阻塞。

设备A发现设备B与自己是不同网段，无法进行ARP通信。设备A无法获取设备B的MAC地址，所以也就无法通信。

## ARP缓存未过期之前，目标设备改成不同网段，是否还能通信？

设备并不是每次通信通信前都要执行的ARP查询MAC地址的，因为这样效率很慢，还会使网络多出很多ARP包。在执行一次ARP后，设备会将目标设备的MAC地址保存在自己的内存中，下一次再通信的时候直接取出来用即可。

windows电脑上可以在cmd上使用arp -a命令来查看ARP缓存，如下图

![](/img/article-picture/2020-01-29-switch-different-net-communication/2020-01-29-switch-different-net-communication.m_1.png)

前面我们知道ARP无法执行，获取不到目标设备的IP地址，所以无法通信，如果我开始时设备A和设备B是配置成相同网段，并让它们成功通信，那么设备A的ARP缓存中就保留了设备B的MAC地址，是不是意味着，这时设备B改成了不同网段，如192.168.2.3，是不是设备A也能与设备B通信了？

结果是不能，即使设备A有了设备B的MAC地址，但是设备A发现通信的目标IP与自己不在同一网段，这时设备A会查询自己的路由表，看是否有路由器可以将此包转发出去，如果发现没有适合的路由，那么就会放弃发包。

