---
layout:     post
title:      "C程序中的const和volatile的作用"
date:       2018-12-9 15:15:00
author:     "KM"
catalog: true
tags:
    - Java

---
# NAT及虚拟机NAT模式介绍

## NAT介绍

可以把NAT看作一个路由器，负责将不同网络的数据包地址进行转换，使原本已经分配到本地IP的主机可以与外界通信。

假设nat outside ip为172.16.5.4，inside ip为192.168.1.1

- 如本机192.168.1.2:5421想访问172.16.5.4:80，数据包为：

```
发送者：192.168.1.2:5421 接收者：172.16.5.1:80
```

- 因为本地IP是无法直接与外网IP直接通信，所以NAT将192.168.1.2转换为outside的地址，数据包变为：

```
发送者：172.16.5.4:65 接受者：172.16.5.1:80   
```

NAT在发送数据前，需要建立NAT表用于记录172.16.5.4:65<==>192.168.1.2:5421的映射关系，否则当接收到172.16.5.1:80的返回数据时，它就无法知道将数据包转发为谁。最后NAT把数据从outside端发出去。

- 接受返回的数据包

```
发送者：172.16.5.1:80  接受者：172.16.5.4:65 
```

NAT outside首先查表获取映射172.16.5.4:65<==>192.168.1.2:5421，并将数据包转发给192.168.1.2:5421。

## 虚拟机NAT模式

下图是网上解释虚拟机NAT模式常用的图片。下面分问题来解答我对此图的理解。

![](/img/article-picture/1/1535189418496708.png)

**1.虚拟机为什么与宿主机网段不同？**

首先看到图片右边蓝色虚线框部分与主机网卡IP地址网段不同，主机为192.168.1.xxx，虚拟机为195.168.62.xxx，为什么会网段不同？如果网段相同那么虚拟机就要占用路由器的一个IP，这就变成了桥接模式了。NAT模式就是表示宿主机和虚拟机共用一个IP，也就是192.168.1.101，从而节约IP地址的数量。

**2.虚拟DHCP服务器的作用？**

DHCP服务器为虚拟机提供动态IP。下图中可设置DHCP服务器可分配的IP地址范围。

![](/img/article-picture/1/1571663505834.png)

**3.虚拟NAT设备转换后的数据包源地址IP是主机IP还是路由器的outside IP？**

答案是主机IP（192.168.1.101），开始我以为NAT转换后IP为113.109.111.2，但是NAT属于路由器下的内网设备所以无法获得路由器outside地址，所以NAT转换为主机IP后再由路由器转换为outside地址。

**4.VMware Network Adapter VMnet8的作用是什么？**

首先要知道VMware Network Adapter VMnet8虚拟网卡是主机的，主机开启了虚拟网卡就相当与挂在VMnet8交换机下的设备，与其它虚拟机是同等设备。所以虚拟网卡的IP与虚拟机是同频段，所以在开启虚拟网卡时，虚拟机是直接通过它和主机通信的。

**5.禁用VMware Network Adapter VMnet8网卡后，虚拟机可以ping通主机，反之不行？**

当禁用虚拟网卡后，虚拟机ping主机可以走NAT的通路，因为NAT会将虚拟机数据包IP转换为主机的IP，所以它们可以通信。

当主机ping虚拟机时，NAT设备对于主机来说是透明的，它是无法感知的，只有虚拟机知道它的存在，所以主机认为虚拟机IP与自己在不同网段，然后直接将数据包交给路由器进行转发到外网去了。

所以禁用虚拟网卡不影响虚拟机的外网访问， 但会影响主机和虚拟机间的访问。